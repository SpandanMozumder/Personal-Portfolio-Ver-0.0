"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@react-pdf-viewer/core");function n(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var i=n(e),r=function(e){return e>=0?e:360+e},a=function(e,t){switch(r(t)){case 90:return{height:e.width+"%",position:"absolute",right:e.top+"%",top:e.left+"%",width:e.height+"%"};case 180:return{bottom:e.top+"%",height:e.height+"%",position:"absolute",right:e.left+"%",width:e.width+"%"};case 270:return{height:e.width+"%",position:"absolute",left:e.top+"%",bottom:e.left+"%",width:e.height+"%"};case 0:case 360:default:return{height:e.height+"%",position:"absolute",top:e.top+"%",left:e.left+"%",width:e.width+"%"}}},o=function(e){var t=e.area,n=e.rotation;return i.createElement("div",{className:"rpv-highlight-rect",style:a(t,n)})},l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var s,c=function(){},g=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t}(c),u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t}(c),f=function(e){function t(t,n,i,r){var a=e.call(this)||this;return a.selectedText=t,a.selectionData=i,a.selectionRegion=r,a.highlightAreas=n,a}return h(t,e),t}(c),d=function(e){function t(t,n,i,r){var a=e.call(this)||this;return a.selectedText=t,a.selectionData=i,a.selectionRegion=r,a.highlightAreas=n,a}return h(t,e),t}(c),p=new g,v=new u,w=function(e){var t=i.useState(e.get("rotation")||0),n=t[0],r=t[1],a=function(e){return r(e)};return i.useEffect((function(){return e.subscribe("rotation",a),function(){e.unsubscribe("rotation",a)}}),[]),{rotation:n}},m=function(e){var t=e.pageIndex,n=e.renderHighlightContent,r=e.renderHighlightTarget,l=e.renderHighlights,h=e.store,s=i.useState(h.get("selectionState")),c=s[0],g=s[1],u=w(h).rotation,v=function(e){return g(e)},m=function(){window.getSelection().removeAllRanges(),h.update("selectionState",p)};i.useEffect((function(){return h.subscribe("selectionState",v),function(){h.unsubscribe("selectionState",v)}}),[]);var x=c instanceof d?c.highlightAreas.filter((function(e){return e.pageIndex===t})):[];return i.createElement(i.Fragment,null,r&&c instanceof f&&c.selectionRegion.pageIndex===t&&r({highlightAreas:c.highlightAreas,selectedText:c.selectedText,selectionRegion:c.selectionRegion,selectionData:c.selectionData,cancel:m,toggle:function(){h.update("selectionState",new d(c.selectedText,c.highlightAreas,c.selectionData,c.selectionRegion)),window.getSelection().removeAllRanges()}}),n&&c instanceof d&&c.selectionRegion.pageIndex===t&&n({highlightAreas:c.highlightAreas,selectedText:c.selectedText,selectionRegion:c.selectionRegion,selectionData:c.selectionData,cancel:m}),x.length>0&&i.createElement("div",null,x.map((function(e,t){return i.createElement(o,{key:t,area:e,rotation:u})}))),l&&l({pageIndex:t,rotation:u,getCssProperties:a}))},x=function(e,t,n){var i=e.cloneNode(!0);e.parentNode.appendChild(i);var r=i.firstChild,a=new Range;a.setStart(r,t),a.setEnd(r,n);var o=document.createElement("span");a.surroundContents(o);var l=o.getBoundingClientRect();return i.parentNode.removeChild(i),l},b=function(e,t,n,i,r){var a=[].slice.call(e.children);if(t<i)return a.slice(t,t+1).map((function(e){return e.textContent.substring(n).trim()})).join(" ")+" "+a.slice(t+1,i).map((function(e){return e.textContent.trim()})).join(" ")+" "+a.slice(i,i+1).map((function(e){return e.textContent.substring(0,r||e.textContent.length)})).join(" ");var o=a[t];return o.textContent.substring(n,r||o.textContent.length).trim()};!function(e){e.SameDiv="SameDiv",e.DifferentDivs="DifferentDivs",e.DifferentPages="DifferentPages"}(s||(s={}));var S=s,C=function(e){var t=e.store,n=w(t).rotation,a=i.useRef(null),o=i.useState(!1),l=o[0],h=o[1],s=function(e){var t=e();a.current=t,h(!!t)},c=function(){var e=document.getSelection(),i=t.get("selectionState");if((i===p||i===v)&&e.rangeCount>0&&""!==e.toString()){var a,o,l=e.getRangeAt(0),h=l.startContainer.parentNode,s=l.endContainer.parentNode,c=s instanceof HTMLElement&&s.hasAttribute("data-highlight-text-layer");if(c&&0==l.endOffset?o=(a=l.endContainer.previousSibling).textContent.length:c?(a=l.endContainer,o=l.endOffset):(a=s,o=l.endOffset),h instanceof HTMLElement&&a instanceof HTMLElement){var g=parseInt(h.getAttribute("data-highlight-text-page"),10),u=parseInt(a.getAttribute("data-highlight-text-page"),10),d=h.parentElement,w=a.parentElement,m=d.getBoundingClientRect(),C=[].slice.call(d.querySelectorAll("[data-highlight-text-page]")),E=C.indexOf(h),D=w.getBoundingClientRect(),I=[].slice.call(w.querySelectorAll("[data-highlight-text-page]")),y=I.indexOf(a),O=S.DifferentPages;switch(!0){case g===u&&E===y:O=S.SameDiv;break;case g===u&&E<y:O=S.DifferentDivs;break;default:O=S.DifferentPages}var R=function(e,t,n){return Array(t-e+1).fill(0).map((function(t,i){return n[e+i].getBoundingClientRect()}))},P=[];switch(O){case S.SameDiv:var A=x(h,l.startOffset,o);P=[{height:100*A.height/m.height,left:100*(A.left-m.left)/m.width,pageIndex:g,top:100*(A.top-m.top)/m.height,width:100*A.width/m.width}];break;case S.DifferentDivs:P=[x(h,l.startOffset,h.textContent.length)].concat(R(E+1,y-1,C)).concat([x(a,0,o)]).map((function(e){return{height:100*e.height/m.height,left:100*(e.left-m.left)/m.width,pageIndex:g,top:100*(e.top-m.top)/m.height,width:100*e.width/m.width}}));break;case S.DifferentPages:var T=[x(h,l.startOffset,h.textContent.length)].concat(R(E+1,C.length-1,C)).map((function(e){return{height:100*e.height/m.height,left:100*(e.left-m.left)/m.width,pageIndex:g,top:100*(e.top-m.top)/m.height,width:100*e.width/m.width}})),H=R(0,y-1,I).concat([x(a,0,o)]).map((function(e){return{height:100*e.height/D.height,left:100*(e.left-D.left)/D.width,pageIndex:u,top:100*(e.top-D.top)/D.height,width:100*e.width/D.width}}));P=T.concat(H)}var j,L="";switch(O){case S.SameDiv:L=b(d,E,l.startOffset,E,o);break;case S.DifferentDivs:L=b(d,E,l.startOffset,y,o);break;case S.DifferentPages:L=b(d,E,l.startOffset,C.length)+"\n"+b(w,0,0,y,o)}if(P.length>0)j=P[P.length-1];else{var _=a.getBoundingClientRect();j={height:100*_.height/D.height,left:100*(_.left-D.left)/D.width,pageIndex:u,top:100*(_.top-D.top)/D.height,width:100*_.width/D.width}}var M={startPageIndex:g-1,endPageIndex:u-1,startOffset:l.startOffset,startDivIndex:E,endOffset:o,endDivIndex:y};t.update("selectionState",new f(L,P.map((function(e){return function(e,t){switch(r(t)){case 90:return{height:e.width,left:e.top,pageIndex:e.pageIndex,top:100-e.width-e.left,width:e.height};case 180:return{height:e.height,left:100-e.width-e.left,pageIndex:e.pageIndex,top:100-e.height-e.top,width:e.width};case 270:return{height:e.width,left:100-e.height-e.top,pageIndex:e.pageIndex,top:e.left,width:e.height};case 0:case 360:default:return e}}(e,n)})),M,j))}}};return i.useEffect((function(){var e=a.current;if(e)return e.addEventListener("mouseup",c),function(){e.removeEventListener("mouseup",c)}}),[l,n]),i.useEffect((function(){return t.subscribe("getPagesContainer",s),function(){t.unsubscribe("getPagesContainer",s)}}),[]),i.createElement(i.Fragment,null)};exports.MessageIcon=function(){return i.createElement(t.Icon,{size:16},i.createElement("path",{d:"M23.5,17a1,1,0,0,1-1,1h-11l-4,4V18h-6a1,1,0,0,1-1-1V3a1,1,0,0,1,1-1h21a1,1,0,0,1,1,1Z"}),i.createElement("path",{d:"M5.5 12L18.5 12"}),i.createElement("path",{d:"M5.5 7L18.5 7"}))},exports.highlightPlugin=function(e){var n=i.useMemo((function(){return t.createStore({selectionState:p})}),[]);return{install:function(e){n.update("getPageElement",e.getPageElement),n.update("getPagesContainer",e.getPagesContainer)},onViewerStateChange:function(e){return n.update("rotation",e.rotation),e},jumpToHighlightArea:function(e){var t=n.get("getPagesContainer"),i=n.get("getPageElement");if(t&&i){var r=t();if(r){var a=i(e.pageIndex);r.scrollTop=a.offsetTop+e.top*a.clientHeight/100-r.offsetTop}}},onTextLayerRender:function(e){var i,r=(i=e,function(e){var t=i.ele.getBoundingClientRect(),r=n.get("selectionState");if(r instanceof f){var a=e.clientY-t.top,o=e.clientX-t.left;r.highlightAreas.filter((function(e){return e.pageIndex===i.pageIndex})).find((function(e){var n=e.top*t.height/100,i=e.left*t.width/100,r=e.height*t.height/100,l=e.width*t.width/100;return n<=a&&a<=n+r&&i<=o&&o<=i+l}))?(window.getSelection().removeAllRanges(),n.update("selectionState",p)):n.update("selectionState",v)}else n.update("selectionState",p)}),a=e.ele;switch(e.status){case t.LayerRenderStatus.PreRender:a.removeEventListener("mousedown",r);break;case t.LayerRenderStatus.DidRender:a.addEventListener("mousedown",r),a.setAttribute("data-highlight-text-layer","true"),a.querySelectorAll(".rpv-core-text").forEach((function(t){return t.setAttribute("data-highlight-text-page",""+e.pageIndex)}))}},renderPageLayer:function(t){return i.createElement(m,{pageIndex:t.pageIndex,renderHighlightContent:e&&e.renderHighlightContent?e.renderHighlightContent:null,renderHighlightTarget:e&&e.renderHighlightTarget?e.renderHighlightTarget:null,renderHighlights:e&&e.renderHighlights?e.renderHighlights:null,store:n})},renderViewer:function(e){var t=e.slot;return t.subSlot&&t.subSlot.children&&(t.subSlot.children=i.createElement(i.Fragment,null,i.createElement(C,{store:n}),t.subSlot.children)),t}}};
